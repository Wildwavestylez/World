<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Dopravní Terminál</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #main-container { display: flex; flex-direction: column; height: 100%; }
    #map { flex: 1 1 70%; }
    #panel {
      flex: 1 1 30%;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      border-top: 2px solid #ccc;
    }
    #tabs { display: flex; border-bottom: 1px solid #ddd; }
    .tab {
      flex: 1; padding: 10px; background: #eee;
      border: none; cursor: pointer;
    }
    .tab.active { background: #fff; font-weight: bold; }
    #tab-content { padding: 10px; overflow-y: auto; flex: 1; }
  
  /* Modal základní styl */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-content {
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  width: 300px;
  max-width: 90%;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.close-btn {
  float: right;
  cursor: pointer;
  font-weight: bold;
}
  
  
  
  </style>
</head>
<body>
  <div id="main-container">
    <div id="map"></div>
    <div id="panel">
      <div id="tabs">
        <button class="tab active" data-tab="dispatch">Dispečink</button>
        <button class="tab" data-tab="vehicles">Vozidla</button>
        <button class="tab" data-tab="economy">Ekonomika</button>
        <button class="tab" data-tab="progress">Vývoj</button>
      </div>
      <div id="tab-content">
        <h3>Dispečink</h3>
        <p>Zde budou skupiny cestujících podle cíle.</p>
        
        
      </div>
<!-- VOZIDLA – výpis vlastněných autobusů -->
<div id="tab-content-vehicles" class="tab-section" style="display: none;">
  <h3>Vozidla</h3>
  <div id="vehicle-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; padding: 8px;"></div>
</div>

<!-- MODÁLNÍ OKNO pro detail autobusu -->
<div id="vehicle-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-btn" onclick="closeVehicleModal()">&times;</span>
    <h3 id="modal-vehicle-name"></h3>
    <p><strong>Typ:</strong> <span id="modal-vehicle-type"></span></p>
    <p><strong>Kapacita:</strong> <span id="modal-vehicle-capacity"></span></p>
    <p><strong>Stav:</strong> <span id="modal-vehicle-status"></span></p>
    <p><strong>Ujeto:</strong> <span id="modal-vehicle-km"></span> km</p>
    <p><strong>Zbývá do servisu:</strong> <span id="modal-vehicle-service"></span> km</p>
    <button onclick="serviceVehicle()">Servis</button>
    <button onclick="sellVehicle()">Prodat</button>
  </div>
</div>
      
<!-- EKONOMIKA -->
<div id="tab-content-economy" class="tab-section" style="display: none;">
  <h3>Ekonomika</h3>
  <p>Zde budou přehledy výdělků, nákladů a stavu účtu.</p>
</div>

<!-- VÝVOJ -->
<div id="tab-content-progress" class="tab-section" style="display: none;">
  <h3>Vývoj</h3>
  <p>Zde bude postupné odemykání nových funkcí (vlaky, letadla...)</p>
</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Výchozí pozice terminálu v Pošumaví
    const terminalLat = 49.1088664;
    const terminalLon = 13.8663668;

    const map = L.map('map').setView([terminalLat, terminalLon], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM',
      maxZoom: 18,
    }).addTo(map);

    // Ikona terminálu
    const terminalIcon = L.icon({
      iconUrl: 'https://i.imgur.com/puN4S0i.jpeg',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    L.marker([terminalLat, terminalLon], { icon: terminalIcon })
      .addTo(map)
      .bindPopup("Váš dopravní terminál – Pošumaví")
      .openPopup();

    let fetchedVillages = [];
const passengerGroups = {}; // { název obce: počet cestujících }

// Fetch nearby villages – už jsme měli
async function fetchNearbyVillages() {
  const overpassUrl = "https://overpass-api.de/api/interpreter";
  const query = `
    [out:json][timeout:25];
    (
      node["place"~"village|town|hamlet"](around:10000,${terminalLat},${terminalLon});
    );
    out body;
  `;
  const response = await fetch(overpassUrl, {
    method: "POST",
    body: query
  });
  const data = await response.json();
  fetchedVillages = data.elements.map(el => ({
    name: el.tags.name || "Neznámá obec",
    lat: el.lat,
    lon: el.lon
  }));
  console.log("Nalezené obce:", fetchedVillages);
  startGeneratingPassengers();
}

// Spuštění generování cestujících
function startGeneratingPassengers() {
  setInterval(() => {
    if (fetchedVillages.length === 0) return;

    const randomIndex = Math.floor(Math.random() * fetchedVillages.length);
    const destination = fetchedVillages[randomIndex].name;

    if (!passengerGroups[destination]) {
      passengerGroups[destination] = 1;
    } else {
      passengerGroups[destination]++;
    }

    renderDispatchTab(); // vykreslí se jen když dispečink je aktivní
  }, 3000);
}

// Přepis vykreslování obsahu Dispečinku
function renderDispatchTab() {
  // Ověříme, že aktivní tab je opravdu "dispatch"
  const activeTab = document.querySelector('.tab.active')?.dataset.tab;
  if (activeTab !== 'dispatch') return;

  const entries = Object.entries(passengerGroups);
  entries.sort((a, b) => b[1] - a[1]);

  let html = `<h3>Dispečink</h3>`;
  if (entries.length === 0) {
    html += `<p>Žádní cestující zatím nečekají.</p>`;
  } else {
    html += `
      <div style="max-height: 170px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 5px;">Cíl</th>
              <th style="text-align: right; padding: 5px;">Počet cestujících</th>
            </tr>
          </thead>
          <tbody>
    `;

    entries.forEach(([destination, count]) => {
      html += `
        <tr>
          <td style="padding: 5px;">${destination}</td>
          <td style="padding: 5px; text-align: right;">${count}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  tabContent.innerHTML = html;
}

  fetchNearbyVillages();

    // Přepínání záložek
    const tabs = document.querySelectorAll('.tab');
    const tabContent = document.getElementById('tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabName = tab.dataset.tab;
        renderTab(tabName);
      });
    });

function renderTab(tabName) {
  if (tabName === 'dispatch') {
    renderDispatchTab();
  } else if (tabName === 'vehicles') {
    tabContent.innerHTML = '<h3>Vozidla</h3><div id="vehicle-list"></div>';
    renderVehicleList(); // << přidáno
  } else if (tabName === 'economy') {
    tabContent.innerHTML = '<h3>Ekonomika</h3><p>Peníze, výnosy, náklady.</p>';
  } else if (tabName === 'progress') {
    tabContent.innerHTML = '<h3>Vývoj</h3><p>Milníky a odemykání nových doprav.</p>';
  }
}
  
  // Příkladová datová struktura autobusů
const ownedBuses = [
  {
    id: 1,
    name: "Mikroš 1",
    type: "mikrobus",
    capacity: 6,
    status: "volný",
    kmDriven: 1200,
    kmToService: 800
  },
  {
    id: 2,
    name: "Miník",
    type: "minibus",
    capacity: 15,
    status: "na cestě do Volyně",
    kmDriven: 450,
    kmToService: 1550
  }
];

// Funkce pro vykreslení seznamu vozidel
function renderVehicleList() {
  const list = document.getElementById('vehicle-list');
  list.innerHTML = "";

  ownedBuses.forEach(bus => {
    const item = document.createElement("div");
    item.style.padding = "6px";
    item.style.borderBottom = "1px solid #ddd";
    item.style.cursor = "pointer";
    item.textContent = `${bus.name} – ${bus.status}`;
    item.onclick = () => openVehicleModal(bus);
    list.appendChild(item);
  });
}

// Otevření modálního okna pro detail autobusu
function openVehicleModal(bus) {
  document.getElementById("modal-vehicle-name").textContent = bus.name;
  document.getElementById("modal-vehicle-type").textContent = bus.type;
  document.getElementById("modal-vehicle-capacity").textContent = bus.capacity;
  document.getElementById("modal-vehicle-status").textContent = bus.status;
  document.getElementById("modal-vehicle-km").textContent = bus.kmDriven;
  document.getElementById("modal-vehicle-service").textContent = bus.kmToService;
  document.getElementById("vehicle-modal").style.display = "flex";
}

// Zavření modálu
function closeVehicleModal() {
  document.getElementById("vehicle-modal").style.display = "none";
}

// Základní funkce pro servis a prodej (zatím jen log do konzole)
function serviceVehicle() {
  console.log("Servisováno vozidlo");
  closeVehicleModal();
}

function sellVehicle() {
  console.log("Prodáno vozidlo");
  closeVehicleModal();
}
  
  </script>
</body>
</html>