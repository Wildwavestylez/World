<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berlin Cleaner Simulator — Prototype</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .hamburger { position:absolute; left:10px; top:10px; z-index:1000; background:white;border-radius:6px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,.3); }
    .panel{ position:absolute; left:10px; top:60px; z-index:1000; width:320px; max-height:86vh; overflow:auto; background:rgba(255,255,255,0.98); padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.25);} 
    h3{ margin:6px 0; }
    button,select{ font-size:14px; }
    .station-popup{ min-width:220px }
    .marker-label{ background:rgba(255,255,255,0.9); padding:4px 6px; border-radius:4px; font-weight:600; }
    .employee-row{ display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="hamburger">
    <button id="togglePanel">☰ Menu</button>
  </div>
  <div id="panel" class="panel" style="display:none">
    <h3>Berlin Cleaner Simulator (Prototype)</h3>
    <div>
      <label>Lines loaded: <span id="lineCount">0</span></label>
    </div>
    <hr/>
    <div>
      <label for="lineSelect">Pick a line to drive (player):</label>
      <select id="lineSelect"><option value="">(loading...)</option></select>
      <div style="margin-top:8px;">
        <button id="startDrive">Start driving</button>
        <button id="stopDrive" disabled>Stop</button>
      </div>
    </div>
    <hr/>
    <div>
      <h4>Employees</h4>
      <div id="employeesList"></div>
      <div style="margin-top:8px;">
        <input id="employeeName" placeholder="Name (e.g. Erkan)" />
        <select id="employeeLine"><option value="">Choose line</option></select>
        <button id="hireBtn">Hire (2000€)</button>
      </div>
    </div>
    <hr/>
    <div>
      <h4>Finances</h4>
      <div>€ <span id="money">5000</span></div>
    </div>
    <hr/>
    <div>
      <small>Prototype uses Overpass API to fetch U-Bahn, S-Bahn (approx) and tram route relations for Berlin. Some relations may be large — please be patient while loading.</small>
    </div>
  </div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script>
    // Berlin bbox center
    const map = L.map('map').setView([52.5208,13.4050], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

    // UI
    const panel = document.getElementById('panel');
    document.getElementById('togglePanel').onclick = ()=> panel.style.display = panel.style.display === 'none' ? 'block' : 'none';

    const lineSelect = document.getElementById('lineSelect');
    const employeeLine = document.getElementById('employeeLine');
    const startDriveBtn = document.getElementById('startDrive');
    const stopDriveBtn = document.getElementById('stopDrive');
    const lineCountSpan = document.getElementById('lineCount');
    const employeesList = document.getElementById('employeesList');
    const hireBtn = document.getElementById('hireBtn');
    const employeeNameInput = document.getElementById('employeeName');
    const moneySpan = document.getElementById('money');

    let money = 5000;
    function updateMoney(v){ money = v; moneySpan.textContent = Math.round(money); }

    // Data structures
    const LINES = {}; // id -> {id,name,type,stops:[{id,lat,lng,name,cleanPercent,marker}] , polyline}
    const EMPLOYEES = [];
    let playerRunner = null;

    // Helpers to create Overpass queries
    function overpassQuery(q){
      const url = 'https://overpass-api.de/api/interpreter';
      return fetch(url, { method:'POST', body: 'data='+encodeURIComponent(q) }).then(r=>r.json());
    }

    // Build area id for Berlin
    const areaQuery = 'area[name="Berlin"];';

    // We'll fetch route relations: subway (U-Bahn), tram, and rail with network containing "S-Bahn"
    const multiQuery = `
[out:json][timeout:90];

// Definujeme oblast NRW
area["name"="Nordrhein-Westfalen"]["boundary"="administrative"]->.searchArea;

// U-Bahn
(
  relation[route=subway](area.searchArea);
)->.ubahn;

// Tramvaje
(
  relation[route=tram](area.searchArea);
)->.tram;

// S-Bahn (všechny sítě, které obsahují "S-Bahn")
(
  relation[route=train][network~"S-Bahn"](area.searchArea);
)->.sbahn;

// Regionální vlaky RE a RB
(
  relation[route=train][ref~"^RE|^RB"](area.searchArea);
)->.regional;

// Sloučíme vše dohromady
(.ubahn;.tram;.sbahn;.regional;);
out body;
>;
out body qt;
`;
  // Convert Overpass result (relations + nodes) into LINES structure
    function processOverpassResult(osm){
      // Build map of nodes
      const nodes = {};
      for(const el of osm.elements){
        if(el.type === 'node') nodes[el.id] = el;
      }
      const relations = osm.elements.filter(e=>e.type==='relation');
      for(const rel of relations){
        const id = 'rel/'+rel.id;
        const name = rel.tags && (rel.tags.ref ? (rel.tags.ref + (rel.tags.name ? ' — '+rel.tags.name : '')) : (rel.tags.name||id));
        const routeType = rel.tags && rel.tags.route ? rel.tags.route : 'unknown';
        // extract ordered stop nodes from members
        const stops = [];
        if(rel.members){
          for(const m of rel.members){
            if(m.type==='node' && (m.role==='stop' || m.role==='stop_entry' || m.role==='platform' || m.role==='') && nodes[m.ref]){
              const n = nodes[m.ref];
              stops.push({ id: n.id, lat:n.lat, lng:n.lon, name: n.tags && (n.tags.name || n.tags['local_ref'] || ('stop '+n.id)), cleanPercent: Math.floor(Math.random()*40)+60 });
            }
          }
        }
        // de-duplicate and keep order
        const uniq = [];
        const seen = new Set();
        for(const s of stops){ if(!seen.has(s.id)){ seen.add(s.id); uniq.push(s); } }
        if(uniq.length>1){
          LINES[id] = { id, name, type:routeType, stops:uniq, raw:rel };
        }
      }
      // Draw lines and markers
      let idx = 0;
      for(const k in LINES){
        const ln = LINES[k];
        const latlngs = ln.stops.map(s=>[s.lat,s.lng]);
        ln.polyline = L.polyline(latlngs,{ weight:3, opacity:0.6 }).addTo(map);
        ln.stops.forEach((s,i)=>{
  // na startu 0 % a červená
  s.cleanPercent = 0;

  const marker = L.circleMarker([s.lat,s.lng],{ 
    radius:7, 
    color:'red', 
    fillColor:'red', 
    fillOpacity:0.9 
  }).addTo(map);

  marker.bindTooltip(`${s.name} — Čistota: ${s.cleanPercent} %`,{direction:'top'});
  marker.on('click',()=> openStationPopup(ln.id,i));
  s.marker = marker;

  // spustíme špinění timer (už od nuly to nepojede dolů, ale jen udrží systém konzistentní)
  startDirt(s);
});
        idx++;
      }
      // Populate UI selects
      refreshLineSelects();
      lineCountSpan.textContent = Object.keys(LINES).length;
    }
  
  // inicializace: všechny stanice začínají špinavé (0 %)
function initStationsDirty() {
  for (const lineId in LINES) {
    const ln = LINES[lineId];
    ln.stops.forEach(st => {
      st.cleanPercent = 0;
      updateMarkerColor(st);
    });
  }
}

    function refreshLineSelects(){
      lineSelect.innerHTML = '<option value="">-- select line --</option>';
      employeeLine.innerHTML = '<option value="">-- select line --</option>';
      for(const id in LINES){
        const opt = document.createElement('option'); opt.value = id; opt.textContent = LINES[id].name + ' ('+LINES[id].type+')';
        lineSelect.appendChild(opt);
        const opt2 = opt.cloneNode(true); employeeLine.appendChild(opt2);
      }
    }

    // updateMarkerColor - rozšíříme o update textu v popupu
function updateMarkerColor(st) {
  const color = st.cleanPercent >= 75 ? 'green' 
               : (st.cleanPercent >= 50 ? 'orange' : 'red');
  st.marker.setStyle({ color: color, fillColor: color });

  // tooltip na mapě
  st.marker.bindTooltip(`${st.name} — Čistota: ${Math.round(st.cleanPercent)} %`, { permanent: false });

  // pokud má popup element, aktualizujeme i tam
  if (st.cleanElem) {
    st.cleanElem.textContent = `Čistota: ${Math.round(st.cleanPercent)} %`;
  }
}

// funkce na spuštění špinění
function startDirt(st) {
  if (st.dirtInterval) clearInterval(st.dirtInterval);
  st.dirtInterval = setInterval(() => {
    st.cleanPercent -= 100 / 600; // každou sekundu -0.166 %
    if (st.cleanPercent <= 0) {
      st.cleanPercent = 0;
      clearInterval(st.dirtInterval);
    }
    updateMarkerColor(st);
  }, 1000);
}

// popup se stavem
function openStationPopup(lineId, stationIdx, actorName) {
  const ln = LINES[lineId];
  const st = ln.stops[stationIdx];

  const content = document.createElement('div');
  content.className = 'station-popup';

  const title = document.createElement('div');
  title.innerHTML = `<strong>${st.name}</strong> (${ln.name})`;
  content.appendChild(title);

  // ✅ ukázka čistoty v popupu
  const cleanDiv = document.createElement('div');
  cleanDiv.style.marginTop = '4px';
  st.cleanElem = cleanDiv; // uložíme referenci
  content.appendChild(cleanDiv);
  updateMarkerColor(st);   // hned vyplníme hodnotu

  // úkoly
  const tasks = ['zamést vajgly','vysypat koše','posbírat láhve','otřít sedačky'];
  const taskElems = [];
  const list = document.createElement('div'); list.style.marginTop='6px';

  const taskCount = Math.max(1, Math.round((100-st.cleanPercent)/20)+1);
  for (let i=0; i<taskCount; i++) {
    const div = document.createElement('div');
    const cb = document.createElement('input'); cb.type='checkbox';
    const lbl = document.createElement('label'); lbl.textContent = ' ' + tasks[i%tasks.length];
    div.appendChild(cb); div.appendChild(lbl);
    list.appendChild(div);
    taskElems.push(cb);
  }
  content.appendChild(list);

  const btn = document.createElement('button');
  btn.textContent = 'Dokončit úklid';
  btn.disabled = true;
  btn.style.marginTop = '8px';
  content.appendChild(btn);

  taskElems.forEach(cb => cb.addEventListener('change',()=>{
    btn.disabled = !taskElems.every(c=>c.checked);
  }));

  btn.onclick = ()=>{
    st.cleanPercent = 100;
    updateMarkerColor(st);
    startDirt(st); // pustí nové špinění
    popup.remove();

    if(actorName === 'PLAYER' && playerRunner) playerRunner.nextStation();
  };

  const popup = L.popup({ maxWidth:300 })
    .setLatLng([st.lat,st.lng])
    .setContent(content)
    .openOn(map);
}


  
  
// úklid stanice
function cleanStation(st) {
  st.cleanPercent = 100;
  updateMarkerColor(st);

  // stopni starý interval (pokud běžel)
  if (st.dirtInterval) {
    clearInterval(st.dirtInterval);
  }

  // špinění z 100 → 0 za 10 minut (600 sekund)
  let ticks = 12000;
  st.dirtInterval = setInterval(() => {
    ticks--;
    st.cleanPercent = Math.max(0, (ticks / 12000) * 100);
    updateMarkerColor(st);

    if (ticks <= 0) {
      clearInterval(st.dirtInterval);
    }
  }, 1000); // každou sekundu
}
    // Player runner: drives selected line, stops at each station and opens popup
    class Runner{
      constructor(lineId){ this.lineId=lineId; this.index=0; this.running=false; }
      start(){ this.running=true; this.index=0; this.driveTo(this.index); }
      stop(){ this.running=false; }
      driveTo(idx){
        const ln = LINES[this.lineId];
        if(!ln) return;
        const s = ln.stops[idx];
        // pan map
        map.panTo([s.lat,s.lng]);
        // open popup and wait for player to finish (actorName PLAYER)
        openStationPopup(this.lineId, idx, 'PLAYER');
      }
      nextStation(){
        if(!this.running) return;
        const ln = LINES[this.lineId];
        this.index++;
        if(this.index >= ln.stops.length){
          // finished a full run
          this.index = 0; // loop back
          // pay bonus
          updateMoney(money + 100);
          alert('Hotovo! Dokončil jsi celé kolo linky ' + ln.name + '. Získal jsi 100€ bonus.');
        }
        this.driveTo(this.index);
      }
    }

    // Employees AI
    // helper: vybere random jinou linku než current
function pickRandomLine(currentId) {
  const keys = Object.keys(LINES).filter(id => id !== currentId);
  if (keys.length === 0) return currentId; // fallback: zůstane stejná linka
  return keys[Math.floor(Math.random() * keys.length)];
}

class Employee {
  constructor(name, lineId) {
    this.name = name;
    this.lineId = lineId;
    this.index = 0;
    this.hiredAt = Date.now();
    this.marker = null;
    this.active = true;
    this.speedFactor = 1 + Math.random() * 0.5;
  }

  start() { this.step(); }

  step() {
    if (!this.active) return;
    const ln = LINES[this.lineId];
    if (!ln || !ln.stops || ln.stops.length === 0) return;

    const st = ln.stops[this.index];

    // ensure marker
    if (!this.marker) {
      this.marker = L.marker([st.lat, st.lng], { title: this.name }).addTo(map);
    }

    // pevný čas na úklid (10s)
    const taskTime = 10000;

    this.marker.bindTooltip(
  this.name + ' — uklízí ' + (st.name || 'neznámou stanici'),
  { permanent: false }
).openTooltip();
    setTimeout(() => {
      if (!this.active) return;

      // complete tasks
      st.cleanPercent = Math.min(100, st.cleanPercent + 100);
      updateMarkerColor(st);
      updateMoney(money + 56);

      // posun indexu
      this.index++;

      // dojeli jsme konec linky?
      if (this.index >= ln.stops.length) {
        // vyber novou linku
        const newLineId = pickRandomLine(this.lineId);
        this.lineId = newLineId;
        this.index = 0;
        console.log(this.name + " mění trasu na " + LINES[newLineId].name);
      }

      // přesun na další zastávku (10s delay)
      const nextLn = LINES[this.lineId];
      const next = nextLn.stops[this.index];
      const travelTime = 10000;

      setTimeout(() => {
        if (!this.active) return;
        this.marker.setLatLng([next.lat, next.lng]);
        this.step();
      }, travelTime);

    }, taskTime);
  }

  stop() { this.active = false; if (this.marker) map.removeLayer(this.marker); }
}
    function renderEmployees(){
      employeesList.innerHTML='';
      for(const e of EMPLOYEES){
        const div = document.createElement('div'); div.className='employee-row';
        div.innerHTML = `<div style="flex:1"><strong>${e.name}</strong><br/><small>${LINES[e.lineId] ? LINES[e.lineId].name : '—'}</small></div>`;
        const btn = document.createElement('button'); btn.textContent='Stop'; btn.onclick = ()=>{ e.stop(); renderEmployees(); };
        div.appendChild(btn);
        employeesList.appendChild(div);
      }
    }

    hireBtn.onclick = ()=>{
      const name = employeeNameInput.value.trim() || ('E'+(EMPLOYEES.length+1));
      const lineId = employeeLine.value;
      if(!lineId){ alert('Vyber linku pro zaměstnance'); return; }
      if(money < 2000){ alert('Nemáš dost peněz (2000€ potřeba)'); return; }
      updateMoney(money - 2000);
      const emp = new Employee(name,lineId);
      EMPLOYEES.push(emp);
      emp.start();
      renderEmployees();
    }

    // Start/stop player
    startDriveBtn.onclick = ()=>{
      const id = lineSelect.value; if(!id) { alert('Vyber linku'); return; }
      if(!LINES[id]){ alert('Linka ještě není načtena'); return; }
      if(playerRunner){ playerRunner.stop(); playerRunner=null; }
      playerRunner = new Runner(id);
      playerRunner.start();
      startDriveBtn.disabled = true; stopDriveBtn.disabled = false;
    }
    stopDriveBtn.onclick = ()=>{ if(playerRunner){ playerRunner.stop(); playerRunner=null; } startDriveBtn.disabled=false; stopDriveBtn.disabled=true; }

    // initial fetch
    (async ()=>{
      try{
        const res = await overpassQuery(multiQuery);
        processOverpassResult(res);
      }catch(e){ console.error('Overpass error', e); alert('Nepovedlo se načíst data z Overpass API — zkuste znovu nebo pomaleji (API může být zahlceno).'); }
    })();

  </script></body>
</html>