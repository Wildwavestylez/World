<!doctype html>

<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berlínský Úklid MHD — Prototype</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0}
    #map{height:100%;width:100%}
    #hamburger{position:absolute;top:12px;left:12px;z-index:1200;background:#222;color:#fff;padding:8px;border-radius:6px;cursor:pointer}
    #menu{position:absolute;top:52px;left:12px;z-index:1200;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.2);display:none;min-width:220px}
    #menu h3{margin:0 0 6px}
    .panel{margin-bottom:8px}
    .station-marker{width:12px;height:12px;border-radius:50%;border:2px solid #fff}
    .status-red{background:#e74c3c}
    .status-green{background:#2ecc71}
    .status-yellow{background:#f1c40f}
    #log{position:absolute;right:12px;top:12px;z-index:1200;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;max-width:320px;max-height:60vh;overflow:auto;display:none}
    #controls{position:absolute;right:12px;bottom:12px;z-index:1200;background:#fff;padding:8px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.15)}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="hamburger">☰</div>
  <div id="menu">
    <h3>Berlínský Úklid — Menu</h3>
    <div class="panel">
      <strong>Finance:</strong>
      <div>Peněženka: <span id="money">€100</span></div>
    </div>
    <div class="panel">
      <strong>Zaměstnanci</strong>
      <div id="employees-list">(žádní)</div>
      <button id="hire-btn">Najmout zaměstnance (€200)</button>
    </div>
    <div class="panel">
      <strong>Trasy</strong>
      <div>Vyber linku: <select id="route-select"></select></div>
      <button id="drive-btn">Jít jako hráč</button>
      <button id="assign-btn">Přiřadit zaměstnanci</button>
    </div>
    <div class="panel">
      <button id="save-btn">Uložit hru</button>
      <button id="load-btn">Načíst hru</button>
      <button id="reset-btn">Reset (vymazat)</button>
    </div>
  </div>  <div id="log"></div>
  <div id="controls">
    <button id="toggle-log">Zobrazit log</button>
  </div>  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  <script>
    // ======= Základní nastavení mapy =======
    const map = L.map('map').setView([52.52,13.405], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    // UI prvky
    const hamburger = document.getElementById('hamburger');
    const menu = document.getElementById('menu');
    const moneyEl = document.getElementById('money');
    const hireBtn = document.getElementById('hire-btn');
    const employeesList = document.getElementById('employees-list');
    const routeSelect = document.getElementById('route-select');
    const driveBtn = document.getElementById('drive-btn');
    const assignBtn = document.getElementById('assign-btn');
    const logEl = document.getElementById('log');
    const toggleLogBtn = document.getElementById('toggle-log');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const resetBtn = document.getElementById('reset-btn');

    hamburger.onclick = () => { menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; };

    toggleLogBtn.onclick = () => { logEl.style.display = logEl.style.display === 'block' ? 'none' : 'block'; };

    // ======= Herní stav =======
    const GAME_STATE_KEY = 'berlin_cleaner_save_v1';
    let state = {
      money: 100,
      stations: {}, // id -> {lat,lng,name,cleanPercent,lastClean}
      routes: {}, // id -> {name,stops:[stationIds],polyline}
      employees: [], // {id,name,routeId,posIndex,working}
      player: {routeId:null,posIndex:0,driving:false}
    };

    function saveState(){ localStorage.setItem(GAME_STATE_KEY, JSON.stringify(state)); log('Hra uložena'); }
    function loadState(){
      const s = localStorage.getItem(GAME_STATE_KEY);
      if(s){ state = JSON.parse(s); applyStateToUI(); log('Hra načtena'); }
      else log('Žádné uložené hry');
    }
    function resetState(){ localStorage.removeItem(GAME_STATE_KEY); location.reload(); }

    saveBtn.onclick = saveState; loadBtn.onclick = loadState; resetBtn.onclick = resetState;

    function log(t){ const p = document.createElement('div'); p.textContent = '['+new Date().toLocaleTimeString()+'] '+t; logEl.prepend(p); }

    // ======= Overpass: načtení linek (relationy) a stanic =======
    // Snažíme se stáhnout relationy pro U-Bahn, S-Bahn a tram v Berlíně.
    // Pokud request selže / data nebudou použitelná, padneme na vestavěné zkušební trasy.

    async function fetchOverpass(){
      log('Stahuju data z Overpass API...');
      // nejprve najdeme area id Berlín
      const areaQ = `[out:json][timeout:25];area["name"~"Berlin|Berliner"]["admin_level"="4"]->.searchArea;`;
      // poté relationy pro tram/subway/train (S-Bahn jako train nebo light_rail depends)
      const query = `${areaQ}(
        relation["route"="subway"](area.searchArea);
        relation["route"="tram"](area.searchArea);
        relation["route"="train"]["operator"~"S-Bahn|DB|S-Bahn Berlin"](area.searchArea);
      );out body;>;out skel qt;`;

      try{
        const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST',body:query});
        const data = await res.json();
        log('Overpass odpověděl, zpracovávám...');
        return data;
      }catch(e){
        console.warn('Overpass fetch failed',e);
        log('Chyba při stahování Overpass — použiji testovací data');
        return null;
      }
    }

    // Pomocná: fallback trasy (jednoduché ukázky se souřadnicemi)
    const FALLBACK = {
      routes:[
        {id:'U5_demo',name:'U5 (demo)',stops:[
          {id:'hönow',name:'Hönow',lat:52.5106,lng:13.6933},
          {id:'koppenstr',name:'Koppenstraße',lat:52.5149,lng:13.7098},
          {id:'alex',name:'Alexanderplatz',lat:52.5219,lng:13.4132}
        ]},
        {id:'S1_demo',name:'S1 (demo)',stops:[
          {id:'s1_east',name:'S1 East',lat:52.5400,lng:13.4000},
          {id:'s1_mid',name:'S1 Mid',lat:52.5200,lng:13.3889},
          {id:'s1_west',name:'S1 West',lat:52.5000,lng:13.3500}
        ]}
      ]
    };

    // ======= Renderování stanic a tras =======
    const stationMarkers = {};
    const polylines = {};

    function addStation(st){
      const id = st.id;
      if(state.stations[id]) return id;
      state.stations[id] = {
        id:id, name:st.name||('st-'+id), lat:st.lat, lng:st.lng,
        cleanPercent:100, lastClean:Date.now()
      };
      const el = L.divIcon({className:'', html:`<div class="station-marker status-green" title="${state.stations[id].name}"></div>`});
      const m = L.marker([st.lat,st.lng],{icon:el}).addTo(map);
      m.on('click',()=> openCleaningPopup(id,m));
      stationMarkers[id]=m;
      return id;
    }

    function updateStationMarker(id){
      const st = state.stations[id];
      if(!st) return;
      const el = stationMarkers[id].getElement();
      if(el) {
        if(st.cleanPercent>=80) el.className = 'station-marker status-green';
        else if(st.cleanPercent>=40) el.className = 'station-marker status-yellow';
        else el.className = 'station-marker status-red';
        stationMarkers[id].bindTooltip(`${st.name} — ${Math.round(st.cleanPercent)}%`).openTooltip();
      }
    }

    function addRoute(r){
      if(state.routes[r.id]) return;
      const stops = [];
      const latlngs = [];
      r.stops.forEach(s => {
        const sid = addStation(s);
        stops.push(sid);
        latlngs.push([s.lat,s.lng]);
      });
      state.routes[r.id] = {id:r.id,name:r.name,stops:stops};
      const poly = L.polyline(latlngs,{weight:4,opacity:0.6}).addTo(map);
      polylines[r.id]=poly;
      const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name; routeSelect.appendChild(opt);
    }

    // ======= Cleaning popup (checkbox-based) =======
    function openCleaningPopup(stationId, marker){
      const st = state.stations[stationId];
      const tasks = [
        {key:'cig',label:'Zamést vajgly',time:2,reward:20},
        {key:'bins',label:'Vysypat koše',time:3,reward:30},
        {key:'bottles',label:'Posbírat lahve',time:1,reward:10},
        {key:'graff',label:'Odstranit graffiti',time:5,reward:50,rand:true}
      ];
      let html = `<div style="min-width:220px"><strong>${st.name}</strong><br/><div style='margin-top:6px'>`;
      tasks.forEach(t=>{
        if(t.rand && Math.random()>0.5) return; // graffiti se neobjeví vždy
        html += `<label><input type='checkbox' data-task='${t.key}'/> ${t.label} (${t.reward}€)</label><br/>`;
      });
      html += `<div style='margin-top:8px'><button id='clean-do'>Hotovo</button></div></div>`;
      marker.bindPopup(html).openPopup();

      setTimeout(()=>{
        const btn = document.getElementById('clean-do');
        if(!btn) return;
        btn.onclick = ()=>{
          // spočítat odškrtané
          const ch = marker.getPopup().getElement().querySelectorAll('input[type=checkbox]');
          let total=0, tasksCount=0;
          ch.forEach(c=>{ if(c.checked){ tasksCount++; const t = tasks.find(tt=>tt.key===c.dataset.task); if(t) total+=t.reward; }});
          // zvýšit čistotu a peníze
          if(tasksCount>0){ state.stations[stationId].cleanPercent = Math.min(100, state.stations[stationId].cleanPercent + tasksCount*30);
            state.stations[stationId].lastClean = Date.now();
            state.money += total; moneyEl.textContent = '€'+Math.round(state.money);
            updateStationMarker(stationId);
            log(`Uklizena stanice ${st.name} (+€${total})`);
          } else { log('Nic nebylo odkliknuto'); }
          marker.closePopup();
        };
      },200);
    }

    // ======= Employees (simple AI) =======
    function hireEmployee(){
      if(state.money < 200){ log('Nemáš dost peněz na najmout zaměstnance'); return; }
      state.money -= 200; moneyEl.textContent = '€'+Math.round(state.money);
      const id = 'emp_'+Date.now();
      const emp = {id:id,name:'Zaměstnanec '+(state.employees.length+1),routeId:null,posIndex:0,working:false};
      state.employees.push(emp);
      renderEmployees();
      log('Najat '+emp.name);
    }
    hireBtn.onclick = hireEmployee;

    function renderEmployees(){
      if(state.employees.length===0) employeesList.textContent = '(žádní)';
      else{
        employeesList.innerHTML = '';
        state.employees.forEach(e=>{
          const d = document.createElement('div');
          d.textContent = `${e.name} — ${e.routeId || '(bez trasy)'}`;
          employeesList.appendChild(d);
        });
      }
    }

    assignBtn.onclick = ()=>{
      const rid = routeSelect.value; if(!rid){ log('Vyber trasu'); return; }
      if(state.employees.length===0){ log('Nemáš zaměstnance'); return; }
      const emp = state.employees[0]; // jednoduchě přiřadíme 1. zaměstnance
      emp.routeId = rid; emp.posIndex = 0; emp.working = true;
      renderEmployees(); log(`Přiřazena trasa ${state.routes[rid].name} zaměstnanci ${emp.name}`);
    };

    // Player drive
    driveBtn.onclick = ()=>{
      const rid = routeSelect.value; if(!rid){ log('Vyber trasu'); return; }
      state.player.routeId = rid; state.player.posIndex = 0; state.player.driving = true; log('Hraješ trasu '+state.routes[rid].name);
      playerStep();
    };

    // Movement loops
    function playerStep(){
      if(!state.player.driving) return;
      const route = state.routes[state.player.routeId];
      if(!route) return;
      const idx = state.player.posIndex;
      const stationId = route.stops[idx];
      const marker = stationMarkers[stationId];
      map.panTo([state.stations[stationId].lat,state.stations[stationId].lng]);
      openCleaningPopup(stationId, marker);
      state.player.posIndex = (idx+1) % route.stops.length;
      // čekej krátce než jede dál (simulace času)
      setTimeout(()=>{
        if(state.player.driving) playerStep();
      }, 3000);
    }

    function employeesStep(){
      state.employees.forEach(emp=>{
        if(!emp.working || !emp.routeId) return;
        const route = state.routes[emp.routeId];
        if(!route) return;
        const idx = emp.posIndex;
        const stationId = route.stops[idx];
        // zaměstnanec odkliká automaticky některé úkoly (50-100%)
        const st = state.stations[stationId];
        const chance = Math.random();
        const cleaned = (chance>0.4) ? 60 : 30; // jednoduchost
        st.cleanPercent = Math.min(100, st.cleanPercent + cleaned);
        st.lastClean = Date.now();
        updateStationMarker(stationId);
        log(`${emp.name} uklidil ${state.stations[stationId].name} (${Math.round(st.cleanPercent)}%)`);
        emp.posIndex = (idx+1) % route.stops.length;
      });
    }

    // Clean decay: stanice se postupně zašpiní
    function decayLoop(){
      const now = Date.now();
      Object.values(state.stations).forEach(st=>{
        const mins = (now - st.lastClean)/1000/60;
        // každých 20 min ztrácí např. 40%
        const decay = Math.floor(mins/20)*40;
        const newp = Math.max(0, Math.round(100 - decay));
        if(newp !== st.cleanPercent){ st.cleanPercent = newp; updateStationMarker(st.id); }
      });
    }

    // Periodické ticky
    setInterval(()=>{ employeesStep(); saveState(); }, 1000*20); // zaměstnanci jedou co 20s
    setInterval(()=>{ decayLoop(); }, 1000*10);

    // ======= Inicializace: stáhni Overpass a vykresli =======
    (async ()=>{
      const data = await fetchOverpass();
      if(!data){ // fallback
        FALLBACK.routes.forEach(r=> addRoute(r));
        renderEmployees();
        saveState();
        return;
      }
      // Pokusíme se z dat extrahovat relationy se seznamy node souřadnic
      // Overpass returns elements - nodes, ways, relations. We'll build node map.
      const nodes = {};
      (data.elements||[]).forEach(el=>{ if(el.type==='node') nodes[el.id] = el; });
      const relations = (data.elements||[]).filter(e=>e.type==='relation');
      if(relations.length===0){ FALLBACK.routes.forEach(r=> addRoute(r)); renderEmployees(); saveState(); return; }

      // Create simple routes from relations that have 'members' of type 'node' or 'way' with role 'stop' or 'platform'
      let created = 0;
      relations.forEach(rel=>{
        try{
          const name = rel.tags && (rel.tags.ref || rel.tags.name) || ('route_'+rel.id);
          const stops = [];
          if(rel.members){
            rel.members.forEach(m=>{
              if(m.type==='node' && nodes[m.ref]){
                const n = nodes[m.ref];
                stops.push({id:'n'+n.id,name: n.tags && (n.tags.name||n.tags.ref) || 'st-'+n.id, lat:n.lat, lng:n.lon});
              }
            });
          }
          if(stops.length>=2){ addRoute({id:'r'+rel.id,name:name,stops:stops}); created++; }
        }catch(e){ console.warn('rel parse err',e); }
      });

      if(created===0){ FALLBACK.routes.forEach(r=> addRoute(r)); }
      renderEmployees(); saveState();
    })();

    // Try autoload saved state on start
    (function tryLoad(){ const s = localStorage.getItem(GAME_STATE_KEY); if(s) { loadState(); } })();

    // Make sure markers update periodically
    setInterval(()=>{ Object.keys(stationMarkers).forEach(updateStationMarker); },3000);

    // expose for debugging
    window.__game_state = state;
  </script></body>
</html>