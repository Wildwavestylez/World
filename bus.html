<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autobusová hra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; padding: 20px; }
        h1 { margin-bottom: 10px; font-size: 22px; color: #333; }
        #map-container { width: 90%; max-width: 600px; height: 450px; margin: 10px auto; border-radius: 15px; overflow: hidden; border: 3px solid #333; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2); }
        #map { width: 100%; height: 100%; }
        .btn-container { margin-top: 10px; }
        button { margin: 5px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        #linesList { margin-top: 15px; text-align: left; display: inline-block; }
        .line-item { padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 14px; }
        @media (max-width: 600px) { #map-container { width: 100%; height: 400px; } }
    </style>
</head>
<body>
    <h1>Vyberte startovní oblast</h1>
    <div id="map-container"><div id="map"></div></div>
    <div class="btn-container">
        <button id="confirmBtn" disabled>Potvrdit výběr</button>
        <button id="newLineBtn" style="display: none;">Vytvořit novou linku</button>
        <button id="expandLineBtn" style="display: none;">Rozšiř linku</button>
    </div>

<select id="selectLine" style="display: none;">
    <option value="" disabled selected>Vyber linku</option>
</select>
    <div id="linesList"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([50.0755, 14.4378], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
        
        let marker;
        let busStops = [];
        let currentStops = [];
        let currentRoute;
        let lines = [];
        let lineCounter = 1;

        map.on('click', function (e) {
            if (marker) marker.setLatLng(e.latlng);
            else marker = L.marker(e.latlng).addTo(map);
            document.getElementById('confirmBtn').disabled = false;
        });

        document.getElementById('confirmBtn').addEventListener('click', function () {
            if (!marker) return;
            let lat = marker.getLatLng().lat;
            let lon = marker.getLatLng().lng;

            this.style.display = "none";
            document.getElementById('newLineBtn').style.display = "inline-block";
            document.getElementById('expandLineBtn').style.display = "inline-block";

            let overpassQuery = `[out:json]; node(around:25000, ${lat}, ${lon})["highway"="bus_stop"]; out;`;

            fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`)
                .then(response => response.json())
                .then(data => {
                    data.elements.forEach(busStop => {
                        if (busStop.lat && busStop.lon) {
                            let stopMarker = L.marker([busStop.lat, busStop.lon], {
                                icon: L.icon({ iconUrl: "https://i.imgur.com/ByUDLOI.png", iconSize: [20, 20], iconAnchor: [10, 10] })
                            }).addTo(map).bindPopup(busStop.tags.name || "Zastávka bez názvu");

                            stopMarker.on('click', () => selectBusStop(busStop.lat, busStop.lon, stopMarker));

                            busStops.push({ lat: busStop.lat, lon: busStop.lon, name: busStop.tags.name || "Neznámá zastávka", marker: stopMarker });
                        }
                    });
                });
        });

        function selectBusStop(lat, lon, marker) {
            if (currentStops.includes(marker)) return;
            currentStops.push(marker);
            marker.setIcon(L.icon({ iconUrl: "https://i.imgur.com/bnKjqNX.png", iconSize: [25, 25], iconAnchor: [12, 12] }));

            if (currentStops.length >= 2) {
                updateRoute();
            }
        }

        function updateRoute() {
            if (currentRoute) map.removeLayer(currentRoute);
            let latlngs = currentStops.map(stop => stop.getLatLng());
            currentRoute = L.polyline(latlngs, { color: getRandomColor(), weight: 4 }).addTo(map);
        }

        function createRoute() {
            if (currentStops.length < 2) return alert("Musíte vybrat alespoň dvě zastávky!");
            
            let startStop = busStops.find(stop => stop.marker === currentStops[0]);
            let endStop = busStops.find(stop => stop.marker === currentStops[currentStops.length - 1]);

            let lineName = `Linka ${lineCounter}: ${startStop.name} → ${endStop.name}`;
            lines.push({ id: lineCounter, route: currentRoute, start: startStop, end: endStop });

            updateLinesList();
            lineCounter++;

            currentStops = [];
            currentRoute = null;
        }


let activeRoute = null; // Uchovává právě rozšiřovanou linku

// Funkce pro výběr linky k rozšíření
function selectRouteToExtend(routeIndex) {
    activeRoute = routeIndex; // Nastavíme aktivní linku
    document.querySelectorAll('.route-item').forEach(el => el.classList.remove('selected'));
    document.getElementById(`route-${routeIndex}`).classList.add('selected');
}

        function updateLinesList() {
    let listContainer = document.getElementById("linesList");
    listContainer.innerHTML = "";

    lines.forEach((line, index) => {
        let item = document.createElement("div");
        item.className = "line-item";
        item.id = `line-${index}`;
        item.textContent = `Linka ${index + 1}: ${line.start.name} → ${line.end.name}`;

        // Kliknutím nastavíme aktivní linku pro rozšíření
        item.onclick = () => selectRouteToExtend(index);

        // Pokud je linka aktivní, zvýrazníme ji
        if (activeRoute === index) {
            item.classList.add("selected");
        }

        listContainer.appendChild(item);
    });
}
        function getRandomColor() {
            let colors = ["blue", "red", "green", "purple", "orange"];
            return colors[lines.length % colors.length];
        }

// Přidání nové zastávky k vybrané lince
function extendRoute(stopName, lat, lng) {
    if (activeRoute !== null) {
        routes[activeRoute].stops.push(stopName);
        routes[activeRoute].coords.push({ lat, lng });

        // Aktualizujeme trasu na mapě
        updateRouteOnMap(activeRoute);

        // Aktualizujeme seznam linek
        updateRoutesList();
    }
}

        document.getElementById('newLineBtn').addEventListener('click', function () {
            createRoute();
        });

        // Přidání logiky pro tlačítko "Rozšířit linku"
document.getElementById("expandLineBtn").addEventListener("click", () => {
    alert("Vyberte linku ze seznamu a poté přidejte nové zastávky.");
});

    </script>
</body>
</html>