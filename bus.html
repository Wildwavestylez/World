<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autobusová hra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; padding: 20px; }
        h1 { margin-bottom: 10px; font-size: 22px; color: #333; }
        #map-container { width: 90%; max-width: 600px; height: 450px; margin: 10px auto; border-radius: 15px; overflow: hidden; border: 3px solid #333; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2); }
        #map { width: 100%; height: 100%; }
        .btn-container { margin-top: 10px; }
        button { margin: 5px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        #linesList { margin-top: 15px; text-align: left; display: inline-block; }
        .line-item { padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 14px; cursor: pointer; }
        .line-item.selected { background-color: #007bff; color: white; }
        @media (max-width: 600px) { #map-container { width: 100%; height: 400px; } }
    </style>
</head>
<body>
    <h1>Vyberte startovní oblast</h1>
    <div id="map-container"><div id="map"></div></div>
    <div class="btn-container">
        <button id="confirmBtn" disabled>Potvrdit výběr</button>
        <button id="newLineBtn" style="display: none;">Vytvořit novou linku</button>
        <button id="expandLineBtn" style="display: none;">Rozšiř linku</button>
    </div>
    <div id="linesList"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([50.0755, 14.4378], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
        
        let marker;
        let busStops = [];
        let currentStops = [];
        let currentRoute;
        let lines = [];
        let lineCounter = 1;
        let expandingLine = null;

        map.on('click', function (e) {
            if (marker) marker.setLatLng(e.latlng);
            else marker = L.marker(e.latlng).addTo(map);
            document.getElementById('confirmBtn').disabled = false;
        });

        document.getElementById('confirmBtn').addEventListener('click', function () {
            this.style.display = "none";
            document.getElementById('newLineBtn').style.display = "inline-block";
            document.getElementById('expandLineBtn').style.display = "inline-block";

            fetchBusStops(marker.getLatLng().lat, marker.getLatLng().lng);
        });

        function fetchBusStops(lat, lon) {
            let query = `[out:json]; node(around:5000, ${lat}, ${lon})["highway"="bus_stop"]; out;`;
            fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    data.elements.forEach(busStop => {
                        let stopMarker = L.marker([busStop.lat, busStop.lon], {
                            icon: L.icon({ iconUrl: "https://i.imgur.com/ByUDLOI.png", iconSize: [20, 20] })
                        }).addTo(map).bindPopup(busStop.tags.name || "Zastávka bez názvu");

                        stopMarker.on('click', () => {
                            if (expandingLine) {
                                extendRoute(busStop.lat, busStop.lon, stopMarker);
                            } else {
                                selectBusStop(busStop.lat, busStop.lon, stopMarker);
                            }
                        });

                        busStops.push({ lat: busStop.lat, lon: busStop.lon, name: busStop.tags.name || "Neznámá zastávka", marker: stopMarker });
                    });
                });
        }

        function selectBusStop(lat, lon, marker) {
            if (currentStops.includes(marker)) return;
            currentStops.push(marker);
            if (currentStops.length >= 2) updateRoute();
        }

        function updateRoute() {
            if (currentRoute) map.removeLayer(currentRoute);
            currentRoute = L.polyline(currentStops.map(stop => stop.getLatLng()), { color: getRandomColor(), weight: 4 }).addTo(map);
        }

        function createRoute() {
            if (currentStops.length < 2) return alert("Musíte vybrat alespoň dvě zastávky!");
            let start = currentStops[0];
            let end = currentStops[currentStops.length - 1];

            let line = { id: lineCounter, route: currentRoute, stops: [...currentStops], name: `Linka ${lineCounter}: ${start.getPopup().getContent()} → ${end.getPopup().getContent()}` };
            lines.push(line);
            lineCounter++;

            updateLinesList();
            currentStops = [];
            currentRoute = null;
        }

        function extendRoute(lat, lon, marker) {
    let selectedLine = lines.find(line => line.id === expandingLine);
    if (!selectedLine) return;

    selectedLine.stops.push(marker);
    updateLinesList();
    redrawLine(selectedLine);

    // Po přidání jedné zastávky deaktivujeme režim rozšíření
    expandingLine = null;
    document.querySelectorAll('.line-item').forEach(i => i.classList.remove('selected'));
}

        function redrawLine(line) {
            if (line.route) map.removeLayer(line.route);
            line.route = L.polyline(line.stops.map(stop => stop.getLatLng()), { color: getRandomColor(), weight: 4 }).addTo(map);
        }

        function updateLinesList() {
            let list = document.getElementById("linesList");
            list.innerHTML = "";
            lines.forEach(line => {
                let item = document.createElement("div");
                item.className = "line-item";
                item.textContent = line.name;
                item.onclick = () => { expandingLine = line.id; document.querySelectorAll('.line-item').forEach(i => i.classList.remove('selected')); item.classList.add('selected'); };
                list.appendChild(item);
            });
        }

        function getRandomColor() { return ["blue", "red", "green", "purple", "orange"][lines.length % 5]; }

        document.getElementById('newLineBtn').addEventListener('click', createRoute);
        document.getElementById('expandLineBtn').addEventListener('click', () => expandingLine = null);
    </script>
</body>
</html>