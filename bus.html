<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autobusová hra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; padding: 20px; }
        h1 { margin-bottom: 10px; font-size: 22px; color: #333; }
        #map-container { width: 90%; max-width: 600px; height: 450px; margin: 10px auto; border-radius: 15px; overflow: hidden; border: 3px solid #333; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2); }
        #map { width: 100%; height: 100%; }
        .btn-container { margin-top: 10px; }
        button { margin: 5px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        #linesList { margin-top: 15px; text-align: left; display: inline-block; }
        .line-item { padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 14px; cursor: pointer; }
        .line-item.selected { background-color: #007bff; color: white; }
        @media (max-width: 600px) { #map-container { width: 100%; height: 400px; } }
    </style>
</head>
<body>
    <h1>Vyberte startovní oblast</h1>
    <div id="map-container"><div id="map"></div></div>
    <div class="btn-container">
        <button id="confirmBtn" disabled>Potvrdit výběr</button>
        <button id="newLineBtn" style="display: none;">Vytvořit novou linku</button>
        <button id="expandLineBtn" style="display: none;">Rozšiř linku</button>
    </div>
    <div id="linesList"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([50.0755, 14.4378], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

        let marker;
        let busStops = [];
        let currentStops = [];
        let currentRoute;
        let lines = [];
        let lineCounter = 1;
        let expandingLine = null;

        map.on('click', function (e) {
            if (marker) marker.setLatLng(e.latlng);
            else marker = L.marker(e.latlng).addTo(map);
            document.getElementById('confirmBtn').disabled = false;
        });

        document.getElementById('confirmBtn').addEventListener('click', function () {
            this.style.display = "none";
            document.getElementById('newLineBtn').style.display = "inline-block";
            document.getElementById('expandLineBtn').style.display = "inline-block";

            fetchBusStops(marker.getLatLng().lat, marker.getLatLng().lng);
        });

    // Funkce pro výpočet vzdálenosti mezi dvěma souřadnicemi (v metrech)
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Poloměr Země v km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c * 1000; // Vzdálenost v metrech
    return distance;
}


function fetchBusStops(lat, lon) {
    let query = `[out:json]; node(around:8000, ${lat}, ${lon})["highway"="bus_stop"]; out;`;
    fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            data.elements.forEach(busStop => {
                // Zkontrolujeme, zda již existuje zastávka se stejným názvem a v okruhu 100m
                let existingStop = busStops.find(stop => 
                    stop.name === busStop.tags.name && 
                    getDistance(stop.lat, stop.lon, busStop.lat, busStop.lon) <= 100
                );

                // Pokud zastávka neexistuje, přidáme ji
                if (!existingStop) {
                    let stopMarker = L.marker([busStop.lat, busStop.lon], {
                        icon: L.icon({ iconUrl: "https://i.imgur.com/ByUDLOI.png", iconSize: [20, 20] })
                    }).addTo(map).bindPopup(busStop.tags.name || "Zastávka bez názvu");

                    stopMarker.on('click', () => {
                        if (expandingLine) {
                            extendRoute(busStop.lat, busStop.lon, stopMarker);
                        } else {
                            selectBusStop(busStop.lat, busStop.lon, stopMarker);
                        }
                    });

                    // Přidáme novou zastávku do seznamu
                    busStops.push({ lat: busStop.lat, lon: busStop.lon, name: busStop.tags.name || "Neznámá zastávka", marker: stopMarker });
                }
            });
        });
}

        function selectBusStop(lat, lon, marker) {
            if (currentStops.includes(marker)) return;
            currentStops.push(marker);
            if (currentStops.length >= 2) updateRoute();
        }

        function updateRoute() {
            if (currentRoute) map.removeLayer(currentRoute);
            currentRoute = L.polyline(currentStops.map(stop => stop.getLatLng()), { color: getRandomColor(), weight: 4 }).addTo(map);
        }

        // Herní bilance
let balance = 10000;
let lineCreationCost = 500;
let stopAdditionCost = 100;

// Aktualizace zůstatku na obrazovce
function updateBalanceDisplay() {
    document.getElementById("balance").textContent = `Zůstatek: ${balance} Kč`;
}

// Vytvoření nové linky (s poplatkem)
function createRoute() {
    if (currentStops.length < 2) return alert("Musíte vybrat alespoň dvě zastávky!");

    // První linka zdarma, další s poplatkem
    let cost = lines.length === 0 ? 0 : lineCreationCost;
    if (balance < cost) return alert("Nedostatek financí!");
    balance -= cost;
    lineCreationCost = Math.ceil(lineCreationCost * 1.1); // Další linka bude o 10 % dražší

    let start = currentStops[0];
    let end = currentStops[currentStops.length - 1];

    let line = {
        id: lineCounter,
        route: currentRoute,
        stops: [...currentStops],
        name: `Linka ${lineCounter}: ${start.getPopup().getContent()} → ${end.getPopup().getContent()}`,
        color: getRandomColor()
    };

    lines.push(line);
    lineCounter++;

    updateLinesList();
    updateBalanceDisplay(); // Aktualizace peněz
    currentStops = [];
    currentRoute = null;
}

        // Rozšíření linky (s poplatkem)
function extendRoute(lat, lon, marker) {
    let selectedLine = lines.find(line => line.id === expandingLine);
    if (!selectedLine) return;

    // První dvě zastávky jsou zdarma, další stojí peníze
    let cost = selectedLine.stops.length < 2 ? 0 : stopAdditionCost;
    if (balance < cost) return alert("Nedostatek financí!");
    balance -= cost;
    stopAdditionCost = Math.ceil(stopAdditionCost * 1.1); // Další přidání zastávky bude o 10 % dražší

    selectedLine.stops.push(marker);
    selectedLine.name = `${selectedLine.name.split(" → ")[0]} → ${marker.getPopup().getContent()}`;

    updateLinesList();
    redrawLine(selectedLine);
    updateBalanceDisplay(); // Aktualizace peněz

    expandingLine = null;
    document.querySelectorAll('.line-item').forEach(i => i.classList.remove('selected'));
}

// Výdělek z linek každou minutu
setInterval(() => {
    let earnings = 0;
    lines.forEach(line => {
        let distance = 0;
        for (let i = 1; i < line.stops.length; i++) {
            distance += map.distance(line.stops[i - 1].getLatLng(), line.stops[i].getLatLng()) / 1000; // vzdálenost v km
        }
        earnings += distance * 10; // 10 Kč/km
    });

    balance += Math.floor(earnings);
    updateBalanceDisplay();
}, 20000); // Každou minutu
    
    // Přidáme do HTML element pro zůstatek
document.body.insertAdjacentHTML('afterbegin', '<div id="balance" style="position:absolute; top:10px; left:10px; background:white; padding:5px 10px; border-radius:5px; font-weight:bold;">Zůstatek: 10000 Kč</div>');


        function redrawLine(line) {
    if (line.route) map.removeLayer(line.route);

    // Použijeme barvu linky, pokud je nastavena
    line.route = L.polyline(line.stops.map(stop => stop.getLatLng()), { 
        color: line.color || getRandomColor(), // Pokud není barva, použijeme náhodnou
        weight: 4 
    }).addTo(map);
}

        function updateLinesList() {
            let list = document.getElementById("linesList");
            list.innerHTML = "";
            lines.forEach(line => {
                let item = document.createElement("div");
                item.className = "line-item";
                item.textContent = line.name;
                item.onclick = () => { expandingLine = line.id; document.querySelectorAll('.line-item').forEach(i => i.classList.remove('selected')); item.classList.add('selected'); };
                list.appendChild(item);
            });
        }

        function getRandomColor() {
    const colors = [
        "blue", "red", "green", "purple", "orange", "pink", "cyan", "brown", "grey", "yellow",
        "lime", "teal", "indigo", "violet", "gold", "aqua", "salmon", "coral", "turquoise",
        "magenta", "darkgreen", "darkblue", "periwinkle", "crimson", "chartreuse"
    ];
    return colors[lines.length % colors.length]; // Vybere barvu podle počtu linek
}

        document.getElementById('newLineBtn').addEventListener('click', createRoute);
        document.getElementById('expandLineBtn').addEventListener('click', () => expandingLine = null);
    </script>
</body>
</html>