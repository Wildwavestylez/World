<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rozšiřující se polygon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 78vh;
        }
        #info {
            padding: 16px;
            background: white;
            border-top: 1px solid #ccc;
            font-family: Arial, sans-serif;
            font-size: 16px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
        }
        #expandButton {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        #expandButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="map"></div>  
    <div id="info">
        Peníze: <span id="money">20000</span> Kč | 
        Rozloha: <span id="area">0</span> km² | 
        Počet obyvatel: <span id="population">0</span> | 
        <button id="expandButton" onclick="expandPolygon()">Rozšířit území</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inicializace mapy
        let map = L.map('map').setView([49.1151400, 13.8285094], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let polygonPoints = [];
        let center = [0, 0];  // Výchozí střed bude 0, 0, ale změní se po výběru hráče
        let polygon = L.polygon([], { color: 'blue' }).addTo(map);

        let blockedPoints = {};
        let moveTracker = [];

        let populationDensity = 130; // Hustota zalidnění (obyvatel/km²)
        let money = 20000; // Počáteční peníze
        let expansionCost = 100; // Cena za jeden pohyb polygonu
        let isExpanding = false; // Flag, zda probíhá rozšiřování

        // Funkce pro výpočet vzdálenosti mezi dvěma geografickými body
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Poloměr Země v km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Vzdálenost v kilometrech
        }

        // Funkce pro rozdělení přímky
        function splitLine(point1, point2) {
            let midPoint = [
                (point1[0] + point2[0]) / 2,
                (point1[1] + point2[1]) / 2
            ];
            return midPoint;
        }

        // Funkce pro rozšíření polygonu
        function expandPolygon() {
            if (!isExpanding || money < expansionCost) {
                alert("Nemáte dostatek peněz na rozšíření území!");
                return;
            }

            let center = getCentroid(polygonPoints);
            let totalPoints = polygonPoints.length;

            let availablePoints = polygonPoints
                .map((point, index) => ({ point, index }))
                .filter(({ index }) => !blockedPoints[index]);

            if (availablePoints.length === 0) return;

            let forcedMoveIndex = moveTracker.indexOf(Math.max(...moveTracker));
            let mustMove = moveTracker[forcedMoveIndex] >= totalPoints;

            let selectedIndex;
            if (mustMove) {
                selectedIndex = forcedMoveIndex;
            } else {
                let randomPoint = availablePoints[Math.floor(Math.random() * availablePoints.length)];
                selectedIndex = randomPoint.index;
            }

            // Kontrola přímek a dělení, pokud je vzdálenost > 2 km
            for (let i = 0; i < polygonPoints.length; i++) {
                let nextIndex = (i + 1) % polygonPoints.length;
                let dist = haversine(polygonPoints[i][0], polygonPoints[i][1], polygonPoints[nextIndex][0], polygonPoints[nextIndex][1]);

                if (dist > 2) { // Pokud je vzdálenost > 2 km, rozdělíme přímku
                    let newPoint = splitLine(polygonPoints[i], polygonPoints[nextIndex]);
                    polygonPoints.splice(nextIndex, 0, newPoint);  // Přidáme nový bod do poloviny
                    moveTracker.push(0);
                }
            }

            polygon.setLatLngs(polygonPoints);

            let area = calculatePolygonArea(polygonPoints);
            let population = Math.round(area * populationDensity);

            document.getElementById("area").textContent = area.toFixed(2);
            document.getElementById("population").textContent = population.toLocaleString();
            document.getElementById("money").textContent = money;

            // Odpočítat peníze
            money -= expansionCost;
            document.getElementById("money").textContent = money;

            // Pokud peníze dojdou, zastavit rozšiřování
            if (money < expansionCost) {
                isExpanding = false;
                document.getElementById("expandButton").disabled = true;
            }
        }

        // Funkce pro získání těžiště polygonu
        function getCentroid(points) {
            let latSum = 0, lngSum = 0;
            points.forEach(p => { latSum += p[0]; lngSum += p[1]; });
            return [latSum / points.length, lngSum / points.length];
        }

        // Funkce pro výpočet plochy polygonu (v km²)
        function calculatePolygonArea(points) {
            let earthRadius = 6371; // Poloměr Země v km
            let area = 0;
            let n = points.length;

            for (let i = 0; i < n; i++) {
                let p1 = points[i];
                let p2 = points[(i + 1) % n];

                let lat1 = p1[0] * Math.PI / 180;
                let lon1 = p1[1] * Math.PI / 180;
                let lat2 = p2[0] * Math.PI / 180;
                let lon2 = p2[1] * Math.PI / 180;

                area += (lon2 - lon1) * (2 + Math.sin(lat1) + Math.sin(lat2));
            }

            area = Math.abs(area * earthRadius * earthRadius / 2);
            return area;
        }

        // Funkce pro začátek hry – kliknutí na mapu a potvrzení
        map.on('click', function(event) {
            if (polygonPoints.length === 0) {  // Umožní výběr místa pouze jednou
                let latlng = event.latlng;
                if (confirm("Chcete začít hru v tomto místě?")) {
                    center = [latlng.lat, latlng.lng];
                    polygonPoints = [
                        [center[0] + 0.002, center[1] - 0.002],
                        [center[0] + 0.002, center[1] + 0.002],
                        [center[0] - 0.002, center[1] + 0.002],
                        [center[0] - 0.002, center[1] - 0.002]
                    ];
                    polygon.setLatLngs(polygonPoints);
                    isExpanding = true;  // Povolit rozšiřování
                    document.getElementById("expandButton").disabled = false;
                }
            }
        });

        // Startovací funkce pro rozšiřování
        setInterval(() => {
            if (polygonPoints.length > 0 && isExpanding) {  // Pokud je polygon inicializován
                expandPolygon();
                unlockBlockedPoints();
            }
        }, 1000);
    </script>
</body>
</html>